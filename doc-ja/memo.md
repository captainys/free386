# 雑多メモ集

ドキュメントまわりを整理したときに余った何かの寄せ集め。

## Memo by Japanese in 2016/12/21

ふとしたこから、以前製作したDOS-Extenderの「Free386」をGitHubに公開しておこうと思いました。

どうせ公開するなら、NASM や alink も一緒に収録して（DOS環境があれば）誰でもアセンブルできるようにしようと思ったのが運の尽き。alinkにフラットモード.exe/.comファイル生成時のバグを発見してしまいました。色々狂い出したのがこの辺ですね（苦笑）

alink へのパッチ作業は Linux 上で行いました。そして alink.exp を生成するために [TOWNS-gcc](http://anikun.kutami.jp/towns-gcc/) を使ったのですが、TOWNS-gcc の生成する MPヘッダ 形式の.EXPファイルが Free386 自身で実行できないバグを見つけました。これを修正しないと（普通はEXP実行環境など持っていないので）開発環境を含めての配布ができそうになありません。調べてみると、メモリの割り当て方にバグがあり、メモリ容量が8MBあたりを超え始めると、後ろの方に存在しないメモリ領域を割り当てていました。

実は、当時の Free386 はちゃんと動かないファイルが多く、動作が不安定になることもあって悩んでいたのですか、なんてことはないメモリの割り当てミスだったという。ただこれを調べるために、メモリマップやページングをダンプするツールを作成したため（収録してます）、結構な手間になりました。

さてメモリの割り当てバグが修正されると、ほぼすべてのDOS汎用EXPファイルと、多くのTOWNSソフトが動作するようになりました。しかし、TOWNS-OS最大の謎システムとされる CoCo/NSD ドライバ周りでコケてしまい、F-BASIC386で書かれたソフトなどが起動しません。**ここまで来たら動かしたくなるのが人情というもの（笑）**

そうして CoCo/NSDドライバ の解析に着手するわけです。少し調べると次のことはすぐに分かりました。

* CoCo.EXE は DOSメモリ（リアルメモリ） に常駐する。
* NSDD は 拡張メモリ に常駐する。

つまり CoCo は NSDファイル を拡張メモリにロードして、その情報を管理していると推測されます。さて問題はその管理情報をどうやって取得するかということです。[SYSINIT](http://www.purose.net/befis/download/ito/sysinit.txt)のように常駐しているCoCoメモリの中に情報があるのかな？と思いました。

とりあえず、その辺を調べるため Free386 に、割り込みをフックしてintサービスの実行前と後のレジスタ状況をダンプ出力する機能を付けました。調べる対象としては、仕組み上「NSDドライバを探す必要があり構造がより単純そうなもの」として、指定のNSDドライバを削除する機能がある \hcopy\deldrv.exp を解析しました。

```
------------------------------------------------------------------
Int = 0000_008E  CS:EIP = 000C:0000_1ADC   SS:ESP = 0014:0001_0B88
 DS = 0014        ES = 0060        FS = 0014        GS = 0014
EAX = 0000_C003  EBX = 0000_0001  ECX = 0000_0000  EDX = 0000_66EC
ESI = 0000_0246  EDI = 2074_6E00  EBP = 0001_0C48  FLG = 0000_0046
CR0 = 8000_0021  CR2 = 0000_0000  CR3 = 0002_9000    D0 S1 P1 C0  
------------------------------------------------------------------
*Ret:*
 DS = 0014        ES = 0014        FS = 0014        GS = 0014
EAX = 0000_0003  EBX = 0000_0010  ECX = 0000_0000  EDX = 0001_0C18
ESI = 0000_0246  EDI = 2074_6E00  EBP = 0001_0C48  FLG = 0000_0006
CR0 = 8000_0021  CR2 = 0000_0000  CR3 = 0002_9000    D0 S0 P1 C0  
------------------------------------------------------------------
```

## このソフトの生い立ち

むかしむかし、mtaskというプロジェクトがありました。

FM-TOWNS及びPC-98で動作するパソコン通信ホストプログラム実現のための、EXPファイルで
ネイティブマルチタスク環境（カーネル+シェル）を作成をしようとしていました。
開発は進み、簡単なサンプルプログラムを複数起動し、タスクスイッチする程度までは動いていました。

しかし、この mtask を開発する過程で、DOS-Extenderの壁にぶち当たります。
TOWNS以外の機種ではEXE386を使用していたのですが、
EXE386は作りにかなり問題があり、
その上でマルチタスクカーネルを動かすのは不可能に近いことが分かりました。
古きフリーソフト文化の精神。**ないものは作る！**

そんなわけで、mtaskから派生したのが、このFree386プロジェクトです。

幸いmtaskを開発する過程で、CPUの知識も、DOS-Extenderの知識も、
アセンブラルーチンも結構ありましたので、それらを活用することで開発を始めました。

そのうちに西暦2000年を過ぎてまして、パソコン通信はすでにオワコン。
目的を見失ったFree386は、気づいたらFM-TOWNS、PC-9801、PC/AT互換機で
共通バイナリが動くDOS-Extender環境を目指していました。

そして、ある程度成果が見え、
AT互換機やPC-98でEXPによるグラフィカルなデモ（長船さん作J7-System関連）が動き、
[独自APIの実装下地が整った頃](../f386api/)、開発は下火となりました。

放置された要因は色々ありますが、技術的な問題としては「AT互換機のVESA BIOSがうまく動かなかったこと」と
「TOWNS-OSのCoCoに対応できなかったこと」が大きかったと思います。

10年以上の歳月を経て、GitHub公開にあたりCoCo対応できたことはちょっとだけ感慨深いです（笑）

## EXE386の問題点

- int 29h （高速コンソール出力）が使えない。
- EXE386 自体が「286プロテクトモード」で動作している。
- このため 32MB までしか使えないし、起動が遅い。
- セレクタ操作などの function が微妙に非互換である。
- PACK されているかの判別が甘い。
- 割り込み処理ルーチンが奇数番地に align されていて謎すぎる。
- 仮想86モードで、INTを発行すると一般保護エラー（詳細は忘れた）
- 「cs=0ch / ds=14h」でないと int 21h を発行できない……。
- 発展途中で作成をやめてしまった感がある。

