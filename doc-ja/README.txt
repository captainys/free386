*******************************************************************************
Free386 User's Manual
			'ABK project' all right reserved. (C)nabe@abk
*******************************************************************************
[TAB=8][UTF-8]

文章作成  2001/02/05
最終修正　2016/12/21

-------------------------------------------------------------------------------
●はじめに
-------------------------------------------------------------------------------

　Phar-Lap RUN386 ほぼ互換の DOS-Extender です。
　FM-TOWNS / PC-98x1 / PC/AT 互換機で動作します。

　この DOS-Extender は .EXP 形式（P3 or MP形式）のファイルを
　DOS 環境で実行することが可能です。

　実行には XMS メモリサーバ、VCPI メモリサーバが必要です。
　具体的には、DOS 5以降の HIMEM.SYS および EMM386 が必要です。


-------------------------------------------------------------------------------
●このソフトのライセンス
-------------------------------------------------------------------------------

　Free386およびそのソースファイルについて、PDS（扱い）としています。

　テキスト類やサンプルファイル、ツール等には、他人の著作物が混ざってい
ますので、よく注意して下さい。


-------------------------------------------------------------------------------
●使い方
-------------------------------------------------------------------------------

　コマンドラインで以下のように指定してください。

	free386 [-option] <実行ファイル>


●実行ファイル

　実行する EXP ファイルを指定します。拡張子を省略できます。

　また環境変数 PATH386 及び PATH を参照し（PATH は ディフォルトでは検索対
象になっていません。詳しくは、-p オプションの欄を参照ください）、実行ファ
イルを自動検索します。

　検索の順序は、カレントディレクトリ → PATH386 → PATH の順です。


●オプションスイッチ

　オプションスイッチは、"実行ファイル" よりも手前で指定される '-' で始ま
る文字列はオプションと見なします。実行ファイルより後ろの文字列は、実行フ
ァイルに対するオプションになります（Free386 に対するオプションとしては解
釈されません）。

　複数のオプションを指定する場合は、「-p1 -v1」のように指定してください。
「-p1v1」としても最初に指定したもの以外は解釈されません。
　尚、無効のオプションが指定されていても特にエラーメッセージなどは表示し
ませんし問題もありません。（例えば、run386 から Free386 に変える場合、
-nocrt オプションをわざわざ削る必要はないということです）。

・-v

　冗長な表示を行います。
　表示されるのは、物理メモリ（これはメモリドライバによっては正確な値を返
しません）、使用可能なメモリ、ロードするファイル名などです。

・-p?

　環境変数 PATH にいて、実行ファイルの検索を行うか設定します。

	-p0	検索を行わない（ディフォルト）。
	-p1	検索を行う。

・-c?

　画面モードを変更したり、VRAM に書き込みをするソフトウェアに対して、実行
終了後に画面の初期化を行うか指定します（現在は TOWNS のみで意味を持つ）。

	-c0	初期化しない
	-c1	常に初期化する
	-c2	画面モードのみ初期化する
	-c3	初期化するかは自動判別する（ディフォルト）

　自動判別は、T-BIOS や VRAM のセレクタにアクセスしているかで判別しています。
しかし「うんづ（エミュレーター環境）」では、セレクタアクセスbitを立ててくれ
ません。仕方がないので、VRAMにチェック用データを書き込んで、その値が書き換
わっているかで判断しています。

・-m

　.EXPファイル実行用にメモリを多く確保します。

　通常リアルメモリ（DOSメモリ）は4KB程度しか確保しないのですが、このオプショ
ンを指定すると空きメモリをすべて確保するようになります。

　その他、予約メモリを極限まで少なくし、可能な限り.EXPファイルに割り当てます。

・-i

　間違って他機種用のバイナリを実行しないために機種簡易判別ルーチンを搭載して
います。この機能を ON/OFF できます。

	-i,-i0	機種チェックを行わない
	-i1	機種チェックを行う（ディフォルト）

・-n (TOWNSのみ有効)

　CoCo/NSDドライバのロードと初期化を行わなくなります。


-------------------------------------------------------------------------------
●ディフォルト動作の指定
-------------------------------------------------------------------------------

　Free386 はファイルの先頭に動作定義変数を持っており、実行ファイルに初期値を
書き込むことでディフォルトの動作を変更できます。ただ patcher は用意してない
ため、操作にはバイナリエディタを使用してください。

	offset	初期値	動作
	+04h	1	0=タイトルを表示なし  1=タイトル表示あり
	+05h	0	0=冗長な表示をしない  1=冗長な表示を行う (-v option)
	+06h	1	環境変数 PATH386 を検索する
	+07h	0	環境変数 PATH を検索する (See '-p option')

	+08h	3	CRTCクリアの初期設定 (See '-c option')
	+09h	1	簡易機種チェック (See '-i option')
	+0ah	0	(予約)
	+0bh	0	(予約)

	+0ch	8	ページングのための予約メモリページ数
	+0dh	4	CALL bufferのサイズ（KB）。1～255。
	+0eh	4	プログラム実行用として確保するリアルメモリページ数
	+0fh	0	(予約)

　これらの変数の位置は、将来の Version においても保証されています。

　ページ：メモリの管理単位です。1pgae = 4KB。

●0ch : ページングのための予約メモリページ数

　x86 CPUには、メモリアドレスと実際の物理メモリの対応付けを行うページング
という機構がありますが、そのページングを行うためのメモリを予約しています。

　-m オプション付きで起動すると、この値を0とみなします。

●0dh : CALL bufferのサイズ

　DOS-Extender funtion int 21h/AX=250dh でプログラムに渡される、コールバッ
ファのサイズです。最低でも 1(KB) は必要です。

　-m オプション付きで起動すると、この値を1とみなします。

●0eh : プログラム実行用として確保するリアルメモリページ数

　.EXPに割り当てるリアルメモリ（DOSメモリ）のページ数を指定します。指定値よ
りもメモリが不足する場合は、空いているすべてのリアルメモリを割り当てます。

　-m オプション付きで起動すると、この値を250とみなします。

-------------------------------------------------------------------------------
●現在の問題点
-------------------------------------------------------------------------------

●最大メモリ制限

　使用できる最大メモリが1GBに制限されています。問題はないと思いますが……。

●int 21h におけるバッファサイズの制限

　ファイルリード/ライト以外の DOS function でバッファを使用するもの（例えば
ah=09h の文字列出力）において、バッファに記述されたデータサイズが予め用意さ
れたDOS仲介バッファサイズを越えた場合、越えた分のデータが切捨てられます。

　現状 8-16KB 程度のバッファを用意していますので、通常は問題ないはずです。

●int 21h, Carryの変化

　DOS function 発効時に「キャリーフラグが本来変化しないハズの function」に
おいて、「キャリーフラグが変化」してしまいます。
　しかし、これが問題になるケースは稀と判断し、対応していません（現状での対
応は無駄が多い）。


-------------------------------------------------------------------------------
●このソフトの生い立ち
-------------------------------------------------------------------------------

　むかしむかし、mtask というプロジェクトがありました。

　expファイルでマルチタスク環境を実現し、パソコン通信ホストプログラム等を実現
するためのカーネルおよびシェル環境を作ろうとしていました。たしか、簡単なシェル
プログラムをタスクスイッチする程度までは動いていました。

　しかし mtask を開発する過程で、DOS-Extenderの制約という問題に当たります。
RS-232Cドライバ部を除いてDOS汎用動作を目指して、TOWNS以外の機種ではEXE386を
使用していたのですが、EXE386は作りがイマイチで、その上でマルチタスクカーネル
を動かすには問題だらけであることが分かりました。

　問題があるなら、DOS-Extenderを作ってしまえばいい。

　ここから派生したので、Free386のプロジェクトです。

　幸い mtask を開発する過程で、CPUの知識も、DOS-Extenderの知識も、関連アセ
ンブラルーチンも結構ありましたので、それらを活用することで開発を始めました。

　Free386を本格的に開発したのは、西暦2000年を過ぎていましたので、すでにパソ
コン通信は過去に遺産と化していました。

　そんな中で、このソフトウェアは FM-TOWNS、PC-9801、PC-AT互換機で共通のバイ
ナリが動くDOS-Extender環境として作り上げる方向に進みます。画面モード設定を
共通化し、VRAMを同じ場所に貼り付けてしまえば、ほとんど同じプログラムを動か
すことができるからです。

　そして、ある程度成果が見え、AT互換機やPC-98でEXPによるグラフィカルなデモ
（長船さん作J7-System関連）が動いた頃、開発は下火となり放置されました。


　放置された直接の原因は Free386 だけに熱中できる状況じゃなくなったことで
すが、AT互換機のVESA BIOSがどうにもうまく動かなかったことや、TOWNS-OS の
アプリを動かす互換性として CoCo に対応できなかったことがありました。


　今回、こうして GitHub に公開するにあたり、少しがんばって整備したところ、
CoCoに対応することができました。10数年来の雪辱を果たしたみたいな感じで、
ちょっとだけ感慨深いです（笑）


-------------------------------------------------------------------------------
●EXE386の問題点
-------------------------------------------------------------------------------

　RUN386互換DOS-Extenderとして有名な EXE386 の問題点。

・int 29h （高速コンソール出力）が使えない
・EXE386 自体が「286プロテクトモード」で動作している
・このため 32MB までしか使えないし、起動が遅い
・セレクタの操作などの function が微妙に非互換である
・PACK されているかの判別が甘い
・割り込み処理ルーチンが奇数番地に align されている（謎）
・仮想86モードで、INTを発行すると一般保護エラー（詳細は忘れた）
・発展途中で作成をやめてしまった感がある

　特に問題だったのは「cs=0ch / ds=14h」でないと int 21h を発行できない……
というお粗末な仕様。


-------------------------------------------------------------------------------
●Special thanks（2001年当時のまま）
-------------------------------------------------------------------------------

　Free386 は色々な方々の多大なる協力によって作成されています。
　私一人の力では、ここまで作り上げることは不可能でした。本当にいろんな人に
迷惑を掛けまくりながら進んでおります。迷惑をかけた方々、本当にありがとうご
ざいました。
　そして、もしよろしかったらこれからもよろしくお願いします。


（以下辞書順）
・あにくん
　gcc で作成したプログラムが動かないことがあるバクを報告して頂きました。
　また、Vector 内で TOWNS-gcc 非公式サイトを運営なされてます。

・長船さん
　"J7system with Free386" や "J7system for AT with Free386" を作成されてます。
　また、Free386標準APIのグラフィック関連は基本的に長船さんにお任せする方向で
調整しています。本当にお世話になってます m(_ _)
　AT での VRAM リニアアクセス遅くなってて申し訳ないです(^^;;

・合著@ABKさん
　「VCPI ファンクション打ち込んでメールしてくれ」に始まる、多数の無茶なお願
いや、「あれ調べといて」「こんなルーチン作って」という小間使いのような注文を
引き受けたりしてくれました。
　Free386 のレジストリダンプや、ファイル検索ルーチンなどは、合著氏が作成され
たものです。特に後者は私がやってたら、一体何時になってたか分かりません。
　とりあえず、PC-98 の CRTC/VRAM 周り頑張って調べてくんろ。

・KURさん
　ソース付きの XMSドライバ である XMZ Driver(PC-98用) に関する情報を提供し
て頂きました。また Free386 の動作テストもして頂きました。
　gcc で作成されたプログラムも動きますし、何か書いてみませんか？(笑)

・僧侶の天使さん
　オフィシャル掲示板として、半強制的に "MSV のめいどさん!!" の掲示板を借りて
しまいました。Free386 関連の書き込みが大量発生し、荒らしのような状態にも係わ
らず、文句一つおっしゃらずに本当に感謝してます。
　また、この掲示板で DOS-Extender 関連の書き込みが盛り上がることがなければ、
Free386 の開発を再開するのはもっと遅くなっていたことでしょう。僧侶の天使さん
も色々と興味を持って下さいました。それが大切なきっかけなりました。

・へるみさん
　CTRL-C 中断プログラムのサンプルを作成して頂きました。
　お陰で、MPEGDEC などで CTRL-C 中断が失敗する理由が解明できました。

・PEN@海猫さん
　その昔、某TOWNS系パソ通ネット（東京）で、私が「-pack された .exp の形式が
わから〜〜ん」とボヤいてたときに、サンプルソースを書き込んでくれました。
　現在 Free386 に搭載されている -pack 展開ルーチンは、それを単純に ASM に直
しただけのものです。

・Mamiyaさん
　NASM for TOWNS を作成されました。
　NASM というアセンブラの存在と、NASM で 16bit-Code <-> 32bit-Code を簡単に入
れ替えられるということを知らなければ、Free386 を作成することはなかったかも知
れません。そういう意味では、NASM 作者の方々にも感謝です。
　NASM の仕様などについても、思い込みで色々言っては、その度に教えて頂いてい
ます（汗）
　また、T-BIOS 物理メモリの配置情報などを教え頂きました。tlink.exp が動作し
ない原因を突きとめて Free386改変版 を配布されてました。本当に全く同じタイミ
ングで私も解決していましたが、改変版のソースを見て修正忘れに気付きました……
（これがなければ最後まで気付かなかった可能性大も）

・りう氏
　速攻で TOWNS の DOS モード画面設定サンプルを速攻で作って下さいました。りう
氏とはインタネ以外のネットワークでも会うのですが、謎の多い人です（笑）
　一部のアプリで画面モードが正常に戻らないのもきっと直してくれるでしょう（ぉぃ
　Free386 が進化した際には、きっと専用アプリを作ってくれるでしょう（ぉぃぉぃ

・その他
　I.Takさん、佐藤さん、リンクしてくださった方、他多数の方々（汗）

　リンクしてくれた方、ダウンロードしてくれた方、Free386 関連の話題にレスをく
れた方、それがみんな開発するパワーとなってます。ありがとう。
[EOF]
